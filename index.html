
<!DOCTYPE html>
<html lang="">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="assets/css/style.css">
<title>Xin chào Kotlin Serialization, tạm biệt Gson !</title>
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Xin chào Kotlin Serialization, tạm biệt Gson ! | Nhatquanght’s blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Xin chào Kotlin Serialization, tạm biệt Gson !" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Trong thế giới Android hiện nay đã có rất nhiều các thư viện nổi tiếng và hiệu quả dành cho serialization được ra mắt. Trong đó nổi tiếng nhất có lẽ là Gson - một thư viện đến từ chính ông chủ chủ của hệ điều hành Android - Google. Nhưng cho dù như vậy, team phát triển Kotlin vẫn quyết định cho ra đời một thư viện mới của riêng mình mang tên Kotlin Serialization, dành riêng cho Kotlin. Tại sao lại như vậy ?" />
<meta property="og:description" content="Trong thế giới Android hiện nay đã có rất nhiều các thư viện nổi tiếng và hiệu quả dành cho serialization được ra mắt. Trong đó nổi tiếng nhất có lẽ là Gson - một thư viện đến từ chính ông chủ chủ của hệ điều hành Android - Google. Nhưng cho dù như vậy, team phát triển Kotlin vẫn quyết định cho ra đời một thư viện mới của riêng mình mang tên Kotlin Serialization, dành riêng cho Kotlin. Tại sao lại như vậy ?" />
<link rel="canonical" href="programming/xin-chao-kotlin-serialization-tam-biet-gson/" />
<meta property="og:url" content="programming/xin-chao-kotlin-serialization-tam-biet-gson/" />
<meta property="og:site_name" content="Phuc YNWA’s blog" />
<meta property="og:image" content="assets/images/2020-12-05-kotlin-serialization.png" />
<meta property="og:image:height" content="1001" />
<meta property="og:image:width" content="500" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="assets/images/2020-12-05-kotlin-serialization.png" />
<meta property="twitter:title" content="Xin chào Kotlin Serialization, tạm biệt Gson !" />
<script type="application/ld+json">
{"url":"programming/xin-chao-kotlin-serialization-tam-biet-gson/","@type":"BlogPosting","description":"Trong thế giới Android hiện nay đã có rất nhiều các thư viện nổi tiếng và hiệu quả dành cho serialization được ra mắt. Trong đó nổi tiếng nhất có lẽ là Gson - một thư viện đến từ chính ông chủ chủ của hệ điều hành Android - Google. Nhưng cho dù như vậy, team phát triển Kotlin vẫn quyết định cho ra đời một thư viện mới của riêng mình mang tên Kotlin Serialization, dành riêng cho Kotlin. Tại sao lại như vậy ?","mainEntityOfPage":{"@type":"WebPage","@id":"programming/xin-chao-kotlin-serialization-tam-biet-gson/"},"image":{"height":1001,"width":500,"url":"assets/images/2020-12-05-kotlin-serialization.png","@type":"imageObject"},"headline":"Xin chào Kotlin Serialization, tạm biệt Gson !","dateModified":"2020-12-04T00:00:00+00:00","datePublished":"2020-12-04T00:00:00+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<script type="text/javascript" src="assets/js/darkmode.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-00QHPCC7KF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-00QHPCC7KF');
  </script></head>

<body>
  <main class="container">
    <section class="about">
      <a href=""><img src="assets/portfolio.png" alt="Phuc YNWA"></a>
      <h2 id="title">
        <a href="">Phuc YNWA</a>
      </h2>
      <p class="tagline">Android Developer.</p>
      <ul class="social"><a href="https://github.com/phucynwa" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://www.linkedin.com/in/phucynwa" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><a href="https://twitter.com/phucynwa" target="_blank">
          <li>
            <i class="icon-twitter-squared"></i>
          </li>
        </a></ul><nav class="navigation">
        <ul>
          
          <li>
            <a href="">Home</a>
          </li>
          
          <li>
            <a href="about/">About</a>
          </li>
          
          <li>
            <a href="categories/">Categories</a>
          </li>
          
          <li>
            <a href="daily-notes/">Daily Notes</a>
          </li>
          
        </ul>
      </nav><p>&copy;
      2021</p><div>
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" id="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
      <script type="text/javascript" src="assets/js/darkmode.js"></script></section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="programming/xin-chao-kotlin-serialization-tam-biet-gson/">
    <h2 class="post-title">Xin chào Kotlin Serialization, tạm biệt Gson !</h2>
  </a>
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>Dec 4, 2020</div><ul class="post-categories"><li>Programming</li></ul></div>
  <div class="post">
    <p><em>Trong thế giới Android hiện nay đã có rất nhiều các thư viện nổi tiếng và hiệu quả dành cho serialization được ra mắt. Trong đó nổi tiếng nhất có lẽ là Gson - một thư viện đến từ chính ông chủ chủ của hệ điều hành Android - Google. Nhưng cho dù như vậy, team phát triển Kotlin vẫn quyết định cho ra đời một thư viện mới của riêng mình mang tên Kotlin Serialization, dành riêng cho Kotlin. Tại sao lại như vậy ?</em></p>

<h2 id="kotlin-serialization-là-gì-">Kotlin Serialization là gì ?</h2>

<p>Trong thế giới Android hiện nay đã có rất nhiều các thư viện nổi tiếng và hiệu quả dành cho serialization được ra mắt. Trong đó nổi tiếng nhất có lẽ là Gson - một thư viện đến từ chính ông chủ chủ của hệ điều hành Android - Google. Nhưng cho dù như vậy, team phát triển Kotlin vẫn quyết định cho ra đời một thư viện mới của riêng mình mang tên Kotlin Serialization, dành riêng cho Kotlin. Tại sao lại như vậy ?</p>

<p>Các thư viện serialization hiện có như Gson, Moshi… là những thư viện của Java sử dụng tính năng reflection (*) của Java, khá phù hợp đối với phát triển Android. Thế nhưng Kotlin không chỉ giới hạn trong mỗi Android (JVM), nó còn hỗ trợ các nền tảng khác như JavaScript (Kotlin/JS) và iOS (Kotlin/Native)… Các reflection chỉ hoạt động trên JVM chắc chắn bất khả thi khi làm việc với các nền tảng JS và Native. Ngoài ra, sử dụng reflection trong Android cũng là một nhược điểm lớn (gây memory leak).</p>

<blockquote>
  <p><em>Reflection is a feature in the Java programming language. It allows an executing Java program to examine or “introspect” upon itself, and manipulate internal properties of the program. For example, it’s possible for a Java class to obtain the names of all its members and display them.</em></p>

  <p>Lược dịch: <em>Reflection là một tính năng trong Java. Nó cho phép một chương trình Java đang thực thi kiểm tra hoặc “nội soi” chính nó và thao tác với các thuộc tính bên trong của chương trình. Ví dụ, một lớp Java có thể lấy tên của tất cả các thành viên của nó và hiển thị chúng.</em></p>

  <p>Nguồn: <a href="https://www.oracle.com/technical-resources/articles/java/javareflection.html">https://www.oracle.com/technical-resources/articles/java/javareflection.html</a></p>
</blockquote>

<p>Bên cạnh nguyên nhân cần hỗ trợ multiplatform và việc sử dụng reflections, còn có một điểm trừ khác đối với các thư viện serialization của Java đó là chúng không hỗ trợ các giá trị mặc định trong Kotlin. Để hiểu điều này một cách rõ ràng, hãy nhìn vào ví dụ dưới đây:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">SimpleExample</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">data</span> <span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">var</span> <span class="py">optionalData</span> <span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"empty"</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Khi chúng ta parse một JSON với chỉ một thuộc tính <code class="language-plaintext highlighter-rouge">data</code> thì thuộc tính <code class="language-plaintext highlighter-rouge">optionalData</code> sẽ được gán thành <code class="language-plaintext highlighter-rouge">null</code> thay vì được gán với giá trị mặc định là <code class="language-plaintext highlighter-rouge">"empty"</code> như được khái báo trong data class. Điều này là một vấn đề lớn bởi vì khi một biến được khai báo với kiểu non-nullable (không có dấu ?) thì Kotlin compiler sẽ luôn đảm bảo rằng biến sẽ không bao giờ được gán giá trị <code class="language-plaintext highlighter-rouge">null</code>, nhưng các thư viện Java serialization lại không nhận thức được điều đó. Kết quả từ sự xung đột chức năng này là rất nhiều hành vi không mong muốn sẽ xảy ra trong ứng dụng.</p>

<p>Chính vì thế Kotlin team quyết định tạo ra một thư viện serializaition mà sẽ hoạt động trên tất cả các nền tảng nó đang hỗ trợ mà không dùng đến reflection.</p>

<h2 id="tích-hợp-kotlin-serialization-vào-dự-án">Tích hợp Kotlin Serialization vào dự án</h2>

<p>Để sử dụng thư viện Kotlin Serialization, chúng ta cần tích hợp cả Gradle Plugin và thư viện runtime. Gradle plugin sẽ generate code để parse JSON mà không cần dùng bất kỳ reflection nào. Trong khi đó, thư viện runtime sẽ sử dụng code này để serialize các data class.</p>

<p>Để tích hợp plugin Kotlin Serialization, ta cần khai báo classpath trong file <code class="language-plaintext highlighter-rouge">build.gradle</code> của top-level như sau:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">classpath</span> <span class="s2">"org.jetbrains.kotlin:kotlin-serialization:1.4.20"</span>
</code></pre></div></div>

<p>Nếu dùng Kotlin DSL (build.gradle.kts) thì:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">classpath</span><span class="p">(</span><span class="s">"org.jetbrains.kotlin:kotlin-serialization:1.4.20"</span><span class="p">)</span>
</code></pre></div></div>

<p>Sau đó khai báo plugin trong app level:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'kotlinx-serialization'</span>
</code></pre></div></div>

<p>Kiểu mới:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugin</span> <span class="o">{</span>
  <span class="n">id</span> <span class="s1">'kotlinx-serialization'</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Dùng Kotlin DSL:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">plugin</span> <span class="p">{</span>
  <span class="nf">kotlin</span><span class="p">(</span><span class="s">"plugin.serialization"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Sau đó, bạn có thể thêm implementation trong khối <code class="language-plaintext highlighter-rouge">dependencies</code>:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">implementation</span><span class="p">(</span><span class="s">"org.jetbrains.kotlinx:kotlinx-serialization-runtime:1.0.1"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="cách-dùng-kotlin-serialization-với-data-class">Cách dùng Kotlin Serialization với data class</h2>

<p>Kotlin Serialization có thể được dùng một cách khá nhanh gọn vì đây là một thư viện native của Kotlin team. Chúng ta chỉ cần thêm annotation <code class="language-plaintext highlighter-rouge">@Serializable</code> ngay phía trên của class mong muốn. Kiểu như sau:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Serializable</span>
<span class="kd">data class</span> <span class="nc">SampleDataClass</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">data</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">var</span> <span class="py">optionalData</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"empty"</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Vậy là xong! Bạn không cần phải thêm annotation với mọi thuộc tính của class như đối với Gson.</p>

<p>Tuy nhiên nếu muốn đặt tên tuỳ chỉnh để fit với các attribute name từ JSON chẳng hạn, ta có thể thêm các annotation <code class="language-plaintext highlighter-rouge">@SerialName</code> cho từng thuộc tính:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Serializable</span>
<span class="kd">data class</span> <span class="nc">SampleDataClass</span><span class="p">(</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"data"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">data</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"optional_data"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="py">optionalData</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"empty"</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="tích-hợp-kotlin-serialization-vào-retrofit-2">Tích hợp Kotlin Serialization vào Retrofit 2</h2>

<p>Chúng ta đều đã quen với các Retrofit converter dành cho Gson, Moshi… rồi đúng không. Tương tự như vậy, ta cũng cần phải có một converter dành cho Kotlin Serialization. Có một số thư viện bên thứ ba hỗ trợ việc này. Nhưng để cho uy tín nhất thì có lẽ nên dùng thư viện của anh JakeWharton (một kỹ sư nổi tiếng đến từ Square, tác giả của Timber, Butter-Knife, ThreeTen ABP…).</p>

<p>Thêm vào dependencies:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">implementation</span><span class="p">(</span><span class="s">"com.jakewharton.retrofit:retrofit2-kotlinx-serialization-converter:0.8.0"</span><span class="p">)</span>
</code></pre></div></div>

<p>Sau đó thêm vào nơi khai báo Retrofit:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">contentType</span> <span class="p">=</span> <span class="s">"application/json"</span><span class="p">.</span><span class="nf">toMediaType</span><span class="p">()</span>
<span class="kd">val</span> <span class="py">retrofit</span> <span class="p">=</span> <span class="nc">Retrofit</span><span class="p">.</span><span class="nc">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">baseUrl</span><span class="p">(</span><span class="s">"https://example.com/"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">addConverterFactory</span><span class="p">(</span><span class="nc">Json</span><span class="p">.</span><span class="nf">asConverterFactory</span><span class="p">(</span><span class="n">contentType</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="các-tính-năng-ẩn-hữu-ích">Các tính năng ẩn hữu ích</h2>

<h3 id="compile-time-safety">Compile-time safety</h3>

<p>Điều này dành cho lúc bạn làm việc với các serialization phức tạp, ví dụ như khi bạn có các class được lồng bên trong một response data class.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Serializable</span>
<span class="kd">data class</span> <span class="nc">ProfileResponse</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">profile</span><span class="p">:</span> <span class="nc">Profile</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Tất nhiên bạn cần phải thêm annotation <code class="language-plaintext highlighter-rouge">@Serialization</code> cho class <code class="language-plaintext highlighter-rouge">ProfileResponse</code>, nhưng nếu chẳng may bạn quên thêm annotation cho class <code class="language-plaintext highlighter-rouge">Profile</code> thì sao ? Ứng dụng sẽ crash lúc runtime ? Hay là bạn sẽ phải tự mình check để đảm bảo mọi class lồng bên trong đều đã được thêm annotation ?</p>

<p>Thật may là bạn không cần phải vất vả đến thế. Ứng dụng sẽ không bao giờ crash và bạn cũng không cần phải tự check do Kotlin Serialization là một compile-time safe. Nó sẽ hiển thị một error nếu bạn chưa thêm annotation trên bất kỳ nested class nào, bất kể cấu trúc class của bạn có sâu bao nhiêu.</p>

<h3 id="các-annotation-transient-và-optional">Các annotation @Transient và @Optional</h3>

<ul>
  <li>
    <p><strong>Transient</strong>: Bằng cách gán annotation này vào một thuộc tính trong data class, chúng ta đang chỉ định trường này <strong>bị bỏ qua hoàn toàn</strong> bởi Serializer.</p>
  </li>
  <li>
    <p><strong>Optional</strong>: Bằng cách gán annotation này vào trong data class, chúng ta đang chỉ định trường này là <strong>tuỳ chọn</strong> do đó không được break process nếu không tìm thấy trường này trong response. Chúng ta cũng có thể gán một giá trị mặc định như dưới đây:</p>

    <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Optional</span>
<span class="kd">var</span> <span class="py">isOptional</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">false</span>
<span class="nd">@Transient</span>
<span class="kd">var</span> <span class="py">isTransient</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</code></pre></div>    </div>

    <p>Cả 2 annotation này đều rất hợp lý, nhưng không hiểu vì sao các thư viện của Java lại thiếu mất chúng.</p>
  </li>
</ul>

<hr />

<p>Tham khảo từ: <a href="https://medium.com/better-programming/why-and-how-to-use-kotlins-native-serialization-library-c88c0f14f93d">https://medium.com/better-programming/why-and-how-to-use-kotlins-native-serialization-library-c88c0f14f93d</a></p>

  </div>
</div>
<div class="post-container"><div id="disqus_thread" style="margin-top:25px"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'programming/xin-chao-kotlin-serialization-tam-biet-gson/';
      this.page.identifier = 'programming/xin-chao-kotlin-serialization-tam-biet-gson/';
    };
    (function () {
      var d = document, s = d.createElement('script');
      s.src = 'https://phucynwa.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
  powered by Disqus.</a></noscript></div>
<div class="post-container">
  <li class="posts-labelgroup" id="posts-labelgroup">
    <h2 id="posts-label">Related</h2>
  </li>
  <a class="post-link" href="poem/gap-em-mot-chieu-tren-duong-xuan-thuy/">
    <h3 class="post-title">Gặp em một chiều trên đường Xuân Thuỷ</h3>
  </a>
  <div class="post-meta">
    <div class="post-date">
      <i class="icon-calendar"></i>
      Jul 30, 2020
    </div>
  </div>
  <a class="post-link" href="programming/how-to-deploy-a-ktor-app-to-heroku/">
    <h3 class="post-title">How to deploy a Ktor app to Heroku ?</h3>
  </a>
  <div class="post-meta">
    <div class="post-date">
      <i class="icon-calendar"></i>
      Jul 28, 2020
    </div>
  </div>
  <a class="post-link" href="programming/why-does-Kotlin-remove-static-keyword/">
    <h3 class="post-title">Why does Kotlin remove &quot;static&quot; keyword ?</h3>
  </a>
  <div class="post-meta">
    <div class="post-date">
      <i class="icon-calendar"></i>
      Jul 24, 2020
    </div>
  </div>
  
</div>


    </section>
    <section>
      <script type='text/javascript' src='https://www.freevisitorcounters.com/auth.php?id=9d63e3759c501f6d283550ebd0e815baaff71e7d'></script>
      <script type="text/javascript" src="https://www.freevisitorcounters.com/en/home/counter/774941/t/1"></script>
    </section>
  </main>

  
  <script src="assets/js/simple-jekyll-search.min.js"></script>
  <script src="assets/js/search.js"></script>
  
  <link rel="stylesheet" href="assets/css/custom.css">
</body>
</html>
